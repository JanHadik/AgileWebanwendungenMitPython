<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flagstravaganza</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_desktop.css') }}"
          media="screen and (min-width: 768px)">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_mobile.css') }}"
          media="screen and (max-width: 767px)">
</head>
<body>
<div class="navbar">
    <span>Flagstravaganza</span>
    {% if logged_in %}
        <form action="/logout" method="POST">
            <button id="logout-button">Logout</button>
        </form>
    {% else %}
        <form action="/login" method="POST">
            <input type="text" id="username" name="username" placeholder="Username" required>
            <input type="password" id="password" name="password" placeholder="Password" required>
            <button id="login-button">Login</button>
        </form>
        <form action="/register_page" method="POST">
            <button id="register-button">Register</button>
        </form>
    {% endif %}
</div>

<div class="content">
    <div class="left-column">
        <div class="high-scores">
            <h2>Global Rankings</h2>
            <ol>
                {% for score in highest_scores %}
                    <li>{{ score.user }}: {{ score.score }}</li>
                {% endfor %}
            </ol>
        </div>
    </div>
    <div class="middle-column">
        <div class="flag-guess">
            <h1>Guess the Flag</h1>
            <img id="flag-image" src="{{ url_for('static', filename=flag['img_path']) }}" alt="Flag"
                 style="width: 256px; height: auto;">
            <form id="guess-form">
                <label for="guess">Enter the country:</label>
                <input type="text" id="guess" name="guess" required autocomplete="off">
                <input type="hidden" id="flag_country" name="flag_country" value="{{ flag['country'] }}">
                <button type="submit">Guess</button>
            </form>
            <!-- Dropdown list for possible answers -->
            <div id="guess-dropdown"></div>
            <p id="result"></p>
        </div>
    </div>
    <div class="right-column">
        <div class="high-scores">
            <h2>Current Score</h2>
            <p>0</p>
            {% if logged_in %}
                <h2>Your High Score</h2>
                {% if user_highscore %}
                    <p>{{ user_highscore.score }}</p>
                {% else %}
                    <p>No high score yet</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // Array of possible answers
        var possibleAnswers = [
            {% for answer in countries %}
                "{{ answer }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // Function to display possible answers when input is focused
        function updateDropdown() {
            var userInput = $('#guess').val().trim().toLowerCase(); // Get user input and convert to lowercase
            var dropdown = $('#guess-dropdown');
            dropdown.empty(); // Clear previous dropdown items

            if (userInput.length > 0) {
                // Filter possible answers that include the user input
                var filteredAnswers = possibleAnswers.filter(function (answer) {
                    return answer.toLowerCase().includes(userInput);
                });
                // Add each filtered possible answer to the dropdown
                filteredAnswers.forEach(function (answer) {
                    dropdown.append('<button type="button">' + answer + '</button>');
                });
                // Show the dropdown below the input field
                dropdown.css({
                    top: $('#guess').offset().top + $('#guess').outerHeight(),
                    left: $('#guess').offset().left,
                    width: $('#guess').outerWidth()
                }).show();
            } else {
                dropdown.hide(); // Hide dropdown if input is empty
            }
        }

        // Event listener for input focus
        $('#guess').on('input', function () {
            updateDropdown();
        });

        // Hide the dropdown when input loses focus
        $(document).on('click', function (event) {
            if (!$(event.target).closest('#guess-dropdown').length && !$(event.target).is('#guess')) {
                $('#guess-dropdown').hide();
            }
        });

        // Handle selection of an answer from the dropdown
        $('#guess-dropdown').on('click', 'button', function () {
            $('#guess').val($(this).text()); // Set input value to the selected answer
            $('#guess-dropdown').hide(); // Hide the dropdown
        });

        $('#guess-form').submit(function (event) {
            event.preventDefault();
            var formData = $(this).serialize();
            $.post('/check_guess', formData, function (response) {
                $('#result').text(response.result);
                if (response.new_flag) {
                    $('#flag-image').attr('src', '/static/' + response.new_flag.img_path);
                    $('#flag_country').val(response.new_flag.country);
                }
                $('#guess').val(''); // Clear the input field
            });
        });
    });
</script>

</body>
</html>
